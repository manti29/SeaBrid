$(function () {
    $("#gender").val($("#old_gender").val());
    initUploadify("\u4fee\u6539\u5934\u50cf");
    bindSave();
    bindReset();
    bindCancel();
    bindConfirm()
});
function initUploadify(b) {
    $("#file_upload").uploadify({
        auto: !0,
        multi: !1,
        queueID: "file_queue",
        formData: {max_width: 256, max_height: 256},
        buttonText: b,
        buttonClass: "btn btn-success btn-sm",
        fileObjName: "file",
        fileTypeDesc: "Image Files",
        fileTypeExts: "*.gif; *.png; *.jpg; *.jpeg; *.bmp",
        fileSizeLimit: "3MB",
        swf: "../../../static/uploadify/uploadify.swf",
        uploader: "../../../api/upload/?method=put",
        onUploadSuccess: function (b, c, d) {
            $("#file_queue").html("");
            b = $.parseJSON(c);
            0 != b.code ? sysAlert("error", "\u9519\u8bef",
                b.msg) : ($("#file_div").addClass("hidden"), $("#confirm_div").removeClass("hidden"), $("#avatar").attr("src", b.data.remote_path), $("#tmp_avatar_name").val(b.data.remote_name))
        },
        onUploadError: function (b, c, d, e) {
            $("#file_queue").html("");
            sysAlert("error", "\u9519\u8bef", "\u4e0a\u4f20\u5934\u50cf\u5931\u8d25: " + e)
        },
        itemTemplate: '<div id="${fileID}" class="uploadify-queue-item template-upload fade border-box in">\t\t\t\t<div class="upload-thumb radius shadow border-box">\t\t\t\t\t<div class="uploadify-progress">\t\t\t\t\t\t<div class="uploadify-progress-bar"></div>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t</div>'
    });
    $("#file_upload-button").removeClass("uploadify-button").css({
        height: "",
        width: "",
        "line-height": ""
    }).find("span").before('<i class="glyphicon glyphicon-folder-open"></i>&nbsp;&nbsp;')
}
function bindSave() {
    $("#save").click(function () {
        $.ajax({
            type: "post",
            url: "../../../api/account/profile/" + $("#username").val() + "/?method=put",
            data: {
                email: $("#email").val(),
                nick_name: $("#nick_name").val(),
                real_name: $("#real_name").val(),
                gender: $("#gender").val(),
                mobile: $("#mobile").val()
            }
        }).done(function (b) {
            0 === b.code ? ($("#old_email").val($("#email").val()), $("#old_nick_name").val($("#nick_name").val()), $("#old_real_name").val($("#real_name").val()), $("#old_gender").val($("#gender").val()), $("#old_mobile").val($("#mobile").val()),
                sysAlert("success", "\u6210\u529f", "\u4fdd\u5b58\u6210\u529f\uff01")) : sysAlert("error", "\u9519\u8bef", "\u4fdd\u5b58\u5931\u8d25\uff01[" + b.msg + "]")
        }).fail(function (b) {
            sysAlert("error", "\u9519\u8bef", "\u4fdd\u5b58\u5931\u8d25\uff01[" + b.status + " " + b.statusText + "]")
        })
    })
}
function bindReset() {
    $("#reset").click(function () {
        $("#email").val($("#old_email").val());
        $("#nick_name").val($("#old_nick_name").val());
        $("#real_name").val($("#old_real_name").val());
        $("#gender").val($("#old_gender").val());
        $("#mobile").val($("#old_mobile").val())
    })
}
function bindCancel() {
    $("#cancel_file").click(function () {
        $("#confirm_div").addClass("hidden");
        $("#file_div").removeClass("hidden");
        $("#avatar").attr("src", $("#old_avatar_path").val());
        $("#tmp_avatar_name").val("")
    })
}
function bindConfirm() {
    $("#confirm_file").click(function () {
        $("#confirm_div").addClass("hidden");
        $.ajax({type: "post", url: "../../../api/account/avatar/?method=put", data: {filename: $("#tmp_avatar_name").val()}}).done(function (b) {
            0 === b.code ? ($("#avatar").attr("src", b.data.remote_path), $("#old_avatar_path").val(b.data.remote_path), $("#tmp_avatar_name").val(""), sysAlert("success", "\u6210\u529f", "\u4fee\u6539\u6210\u529f\uff01")) : ($("#avatar").attr("src", $("#old_avatar_path").val()), sysAlert("error", "\u9519\u8bef",
                "\u4fee\u6539\u5931\u8d25\uff01[" + b.msg + "]"))
        }).fail(function (b) {
            $("#avatar").attr("src", $("#old_avatar_path").val());
            sysAlert("error", "\u9519\u8bef", "\u4fee\u6539\u5931\u8d25\uff01[" + a.status + " " + a.statusText + "]")
        }).always(function (b) {
            $("#file_div").removeClass("hidden")
        })
    })
};
