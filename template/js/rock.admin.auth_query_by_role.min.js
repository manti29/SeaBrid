var table = null;
$(function () {
    initTree();
    bindRefresh();
    bindQuery()
});
var __branchNo = "", __treeData = {};
function initTree() {
    var a = $("#roleId").val();
    __treeData = getBranchTree("../../api/admin/branch_tree/");
    $("#branchtree1").treeview({
        data: __treeData,
        nodeIcon: "glyphicon",
        emptyIcon: "glyphicon",
        expandIcon: "glyphicon glyphicon-plus",
        collapseIcon: "glyphicon glyphicon-minus",
        showTags: !0,
        levels: 3,
        onNodeSelected: function (b, c) {
            __branchNo = c.no;
            $.ajax({type: "get", url: "../../api/admin/roles/?method=head", data: {branchNo: c.no}}).done(function (b) {
                0 === b.code ? (genRolesList(b.data), 0 != a.replace(/(^s*)|(s*$)/g, "").length &&
                ($("select#roles").val(a), $("#query").click())) : sysAlert("error", "\u9519\u8bef\uff01", "\u67e5\u8be2\u89d2\u8272\u5217\u8868\u5931\u8d25\uff0c\u8bf7\u624b\u5de5\u5237\u65b0\u3002[" + b.msg + " " + b.code + "]")
            }).fail(function (a) {
                sysAlert("error", "\u9519\u8bef\uff01", "\u67e5\u8be2\u89d2\u8272\u5217\u8868\u5931\u8d25\uff0c\u8bf7\u624b\u5de5\u5237\u65b0\u3002[" + a.status + " " + a.statusText + "]")
            })
        }
    });
    var b = $("#branchNo").val();
    if (0 === b.replace(/(^s*)|(s*$)/g, "").length)$("#branchtree1>ul>li:first").click(); else for (var c =
        0, d = 0; d < __treeData.length; d++, c++) {
        if (__treeData[d].no == b) {
            $("#branchtree1>ul>li")[c].click();
            break
        }
        for (var e = __treeData[d].nodes; e && 0 < e.length; e = __treeData[d].nodes) {
            c++;
            for (var f = 0; f < e.length; f++, c++)if (e[f].no === b) {
                $("#branchtree1>ul>li")[c].click();
                return
            }
        }
    }
}
function genRolesList(a) {
    $("select#roles").html("");
    for (var b = 0; b < a.length; b++)$("select#roles").append('<option value="' + a[b].roleId + '">' + a[b].roleName + "</option>")
}
function bindRefresh() {
    $("#refresh").click(function () {
        $.ajax({type: "get", url: "../../api/admin/roles/?method=head", data: {branchNo: __branchNo}}).done(function (a) {
            0 === a.code ? genRolesList(a.data) : sysAlert("error", "\u9519\u8bef\uff01", "\u67e5\u8be2\u89d2\u8272\u5217\u8868\u5931\u8d25\uff0c\u8bf7\u624b\u5de5\u5237\u65b0\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u67e5\u8be2\u89d2\u8272\u5217\u8868\u5931\u8d25\uff0c\u8bf7\u624b\u5de5\u5237\u65b0\u3002[" + a.status +
                " " + a.statusText + "]")
        })
    })
}
function bindQuery() {
    $("#query").click(function () {
        $("#users").removeClass("hidden");
        reloadTable()
    })
}
function reloadTable() {
    null != table && table.destroy();
    table = initTable()
}
function initTable() {
    var a = $("#table-users").DataTable({
        pagingType: "simple_numbers",
        language: {url: "../../static/datatables/locale/zh_CN.txt"},
        ajax: "../../api/admin/roles/" + $("select#roles :selected").val() + "/users/",
        columns: [{data: null}, {data: "username"}, {data: "branchName"}, {data: "realName"}, {data: "gender"}, {data: "startDate"}, {data: "endDate"}, {data: "status"}],
        columnDefs: [{type: "chinese", targets: [1, 2, 3, 4, 7]}, {searchable: !1, orderable: !1, targets: 0}],
        order: [[2, "asc"], [1, "asc"]]
    });
    a.on("order.dt search.dt",
        function () {
            a.column(0, {search: "applied", order: "applied"}).nodes().each(function (a, c) {
                a.innerHTML = c + 1
            })
        }).draw();
    return a
};
