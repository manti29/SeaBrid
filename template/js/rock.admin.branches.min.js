var branch_table = null;
$(function () {
    branch_table = initTable();
    bindQuery();
    bindEdit();
    bindToggleEnable();
    bindAddUser()
});
function bindQuery() {
    $("#btn-query").click(function () {
        $("a#edit").removeClass("disabled");
        $("a#add_user").removeClass("disabled");
        reloadTable()
    })
}
function bindEdit() {
    $("a#edit").click(function () {
        var a = branch_table.row(".selected").data();
        null != a && $.ajax({url: "../../api/admin/branches/" + a.id + "/"}).done(function (a) {
            0 === a.code ? ($("#modal_edit input#id").val(a.data.id), $("#modal_edit input#branch_code").val(a.data.branchNo), $("#modal_edit input#branch_name").val(a.data.branchName), $("#modal_edit input#parent_code").val(a.data.parentBranchNo), $("#modal_edit input#parent_name").val(a.data.parentBranchName), $("#modal_edit input#parent_id").val(a.data.parentBranchId),
                $("#modal_edit select#branch_type").val(a.data.branchType), $("#modal_edit select#biz_line").val(a.data.bizLine), $("#modal_edit p#open_date").text(a.data.openDate), $("#modal_edit p#create_time").text(a.data.createTime), $("#modal_edit p#close_date").text(a.data.closeDate), $("#modal_edit p#last_upd_time").text(a.data.lastUpdTime), $("#modal_edit textarea#description").val(a.data.description), $("#modal_edit").modal("show")) : sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u673a\u6784\u4fe1\u606f\u5931\u8d25\u3002[" +
                a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u673a\u6784\u4fe1\u606f\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    });
    $("#edit_ok").click(function () {
        checkRequired("#modal_edit") && $.ajax({
            type: "post",
            url: "../../api/admin/branches/" + $("#modal_edit form input#id").val() + "/",
            data: getFormJson($("#modal_edit form"))
        }).done(function (a) {
            0 === a.code ? (a = branch_table.row(".selected").data(), a.branchNo = $("#modal_edit input#branch_code").val(), a.branchName =
                $("#modal_edit input#branch_name").val(), a.branchType = $("#modal_edit select#branch_type").val(), a.bizLine = $("#modal_edit select#biz_line").val(), a.branchTypeDesc = $("#modal_edit select#branch_type :selected").text(), a.bizLineDesc = $("#modal_edit select#biz_line :selected").text(), 0 <= a.branchTypeDesc.indexOf("\u8bf7\u9009\u62e9") && (a.branchTypeDesc = ""), 0 <= a.bizLineDesc.indexOf("\u8bf7\u9009\u62e9") && (a.bizLineDesc = ""), a.description = $("#modal_edit textarea#description").val(), branch_table.row(".selected").data(a).draw(!1),
                sysAlert("success", "\u6210\u529f\uff01", "\u4fdd\u5b58\u673a\u6784\u6210\u529f\u3002"), $("#modal_edit").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u673a\u6784\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function bindToggleEnable() {
    $("a#toggle_enable").click(function () {
        var a = branch_table.rows(".selected").data();
        if (null != a)if (chkSelectedBranchesStatus(a)) {
            var b = getSelectedBranches(a);
            "\u505c\u7528" == a[0].statusDesc ? ($("#modal_enable .modal-title").text("\u542f\u7528\u673a\u6784"), $("#modal_enable .modal-body").text("\u786e\u5b9a\u8981\u542f\u7528 " + b + " \u5417\uff1f")) : ($("#modal_enable .modal-title").text("\u505c\u7528\u673a\u6784"), $("#modal_enable .modal-body").text("\u786e\u5b9a\u8981\u505c\u7528 " +
                b + " \u5417\uff1f"));
            $("#modal_enable").modal("show")
        } else sysAlert("error", "\u9519\u8bef\uff01", "\u6240\u9009\u673a\u6784\u7684\u72b6\u6001\u4e0d\u4e00\u81f4")
    });
    $("#enable_ok").click(function () {
        var a = branch_table.rows(".selected").data(), b, c, d, e;
        "\u505c\u7528" == a[0].statusDesc ? (b = "\u542f\u7528", c = "A", d = "\u6709\u6548", e = "") : (b = "\u505c\u7528", c = "B", d = "\u505c\u7528", e = $.format.date(new Date, "yyyy-MM-dd"));
        a = getSelectId(a);
        $.ajax({type: "post", url: "../../api/admin/branches/" + a + "/?method=put", data: {branch_stat: c}}).done(function (a) {
            if (0 ===
                a.code) {
                for (a = 0; a < branch_table.rows(".selected").nodes().length; a++)branch_table.cell(branch_table.rows(".selected").indexes()[a], "6:visIdx").data(e), branch_table.cell(branch_table.rows(".selected").indexes()[a], "7:visIdx").data(d);
                sysAlert("success", b + "\u6210\u529f\uff01", b + "\u673a\u6784\u6210\u529f\u3002");
                $("#modal_enable").modal("hide")
            } else sysAlert("error", "\u9519\u8bef\uff01", b + "\u673a\u6784\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01",
                b + "\u673a\u6784\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function bindAddUser() {
    $("a#add_user").click(function () {
        var a = $.format.date(new Date, "yyyy-MM-dd");
        $("#start_date").parents(".form-group").find("input").each(function () {
            $(this).val(a)
        });
        var b = branch_table.row(".selected").data();
        null != b && ($("#modal_user_add form input[type!=button]").val(""), $("#modal_user_add form select").val(""), $("#modal_user_add form select#gender").val("U"), $("#modal_user_add input#branch_code").val(b.branchNo), $("#modal_user_add input#branch_name").val(b.branchName), $("#modal_user_add input#branch_id").val(b.id),
            a = $.format.date(new Date, "yyyy-MM-dd"), $("#modal_user_add .pick_date").parents(".form-group").find("input").each(function () {
            $(this).val(a)
        }), $("#modal_user_add").modal("show"))
    });
    $("#user_ok").click(function () {
        checkRequired("#modal_user_add") && $.ajax({
            type: "post",
            url: "../../api/admin/users/",
            data: getFormJson($("#modal_user_add form"))
        }).done(function (a) {
            0 === a.code ? (sysAlert("success", "\u6210\u529f\uff01", "\u6dfb\u52a0\u7528\u6237\u6210\u529f\u3002"), $("#modal_user_add").modal("hide")) : sysAlert("error",
                "\u9519\u8bef\uff01", "\u6dfb\u52a0\u7528\u6237\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u6dfb\u52a0\u7528\u6237\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function chkSelectedBranchesStatus(a) {
    for (var b = a[0].statusDesc, c = !0, d = 0; d < a.length; d++)if (a[d].statusDesc != b) {
        c = !1;
        break
    }
    return c
}
function getSelectedBranches(a) {
    for (var b = "", c = 0; c < a.length; c++)b += a[c].branchName + "[" + a[c].branchNo + "]", c < a.length - 1 && (b += ", ");
    return b
}
function reloadTable() {
    branch_table.destroy();
    branch_table = initTable()
}
function getSelectId(a) {
    for (var b = "", c = 0; c < a.length; c++)b += a[c].id, c < a.length - 1 && (b += ",");
    return b
}
function initTable() {
    var a = $("#table-branches").DataTable({
        pagingType: "simple_numbers",
        language: {url: "../../static/datatables/locale/zh_CN.txt"},
        ajax: {url: "../../api/admin/branches/", data: getFormJson($("#query-form"))},
        columns: [{data: "id"}, {data: "branchNo"}, {data: "branchName"}, {data: "bizLineDesc"}, {data: "branchTypeDesc"}, {data: "openDate"}, {data: "closeDate"}, {data: "statusDesc"}],
        columnDefs: [{type: "chinese", targets: [2, 3, 4, 7]}, {searchable: !1, orderable: !1, targets: 0}],
        order: [[1, "asc"]],
        initComplete: function () {
            this.api().$("tr").click(function () {
                $(this).toggleClass("selected");
                1 < branch_table.rows(".selected").data().length ? ($("a#edit").addClass("disabled"), $("a#add_user").addClass("disabled")) : ($("a#edit").removeClass("disabled"), $("a#add_user").removeClass("disabled"))
            })
        }
    });
    a.on("order.dt search.dt", function () {
        a.column(0, {search: "applied", order: "applied"}).nodes().each(function (a, c) {
            a.innerHTML = c + 1
        })
    }).draw();
    return a
};
