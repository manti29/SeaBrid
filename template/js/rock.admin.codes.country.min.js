var table = null;
$(function () {
    table = initDataTable();
    bindNew();
    bindEdit();
    bindDelete()
});
function bindNew() {
    $("a#new").click(function () {
        $("#modal_new input").val("");
        $("#modal_new").modal("show")
    });
    $("#new_ok").click(function () {
        checkRequired("#modal_new") && $.ajax({
            type: "POST", url: "../../../api/admin/country/", dataType: "json", data: {
                chnName: $("#modal_new input[name=chn_name]").val(),
                chnAbbr: $("#modal_new input[name=chn_abbr]").val(),
                engName: $("#modal_new input[name=eng_name]").val(),
                engAbbr: $("#modal_new input[name=eng_abbr]").val(),
                alpha3Code: $("#modal_new input[name=alpha3_code]").val(),
                numCode: $("#modal_new input[name=num_code]").val(),
                alpha2Code: $("#modal_new input[name=alpha2_code]").val()
            }
        }).done(function (a) {
            0 === a.code ? (reloadTable(), sysAlert("success", "\u6210\u529f\uff01", "\u4fdd\u5b58\u6210\u529f\u3002"), $("#modal_new").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function bindEdit() {
    $("a#edit").click(function () {
        if (null != table) {
            var a = table.row(".selected").data();
            $("#modal_edit input[name=country_id]").val(a.id);
            $("#modal_edit input[name=chn_name]").val(a.chnName);
            $("#modal_edit input[name=chn_abbr]").val(a.chnAbbr);
            $("#modal_edit input[name=eng_name]").val(a.engName);
            $("#modal_edit input[name=eng_abbr]").val(a.engAbbr);
            $("#modal_edit input[name=alpha2_code]").val(a.alpha2Code);
            $("#modal_edit input[name=alpha3_code]").val(a.alpha3Code);
            $("#modal_edit input[name=num_code]").val(a.numCode);
            $("#modal_edit").modal("show")
        }
    });
    $("#edit_ok").click(function () {
        if (checkRequired("#modal_edit")) {
            var a = table.row(".selected").data().id;
            $.ajax({
                type: "post", url: "../../../api/admin/country/" + a + "/?method=put", dataType: "json", data: {
                    chnName: $("#modal_edit input[name=chn_name]").val(),
                    chnAbbr: $("#modal_edit input[name=chn_abbr]").val(),
                    engName: $("#modal_edit input[name=eng_name]").val(),
                    engAbbr: $("#modal_edit input[name=eng_abbr]").val(),
                    alpha3Code: $("#modal_edit input[name=alpha3_code]").val(),
                    numCode: $("#modal_edit input[name=num_code]").val(),
                    alpha2Code: $("#modal_edit input[name=alpha2_code]").val()
                }
            }).done(function (a) {
                0 === a.code ? (a = table.row(".selected").data(), a.chnName = $("#modal_edit input[name=chn_name]").val(), a.chnAbbr = $("#modal_edit input[name=chn_abbr]").val(), a.engName = $("#modal_edit input[name=eng_name]").val(), a.engAbbr = $("#modal_edit input[name=eng_abbr]").val(), a.alpha3Code = $("#modal_edit input[name=alpha3_code]").val(), a.numCode = $("#modal_edit input[name=num_code]").val(), a.alpha2Code = $("#modal_edit input[name=alpha2_code]").val(),
                    table.row(".selected").data(a).draw(!1), sysAlert("success", "\u6210\u529f\uff01", "\u4fee\u6539\u6210\u529f\u3002"), $("#modal_edit").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u4fee\u6539\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
            }).fail(function (a) {
                sysAlert("error", "\u9519\u8bef\uff01", "\u4fee\u6539\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
            })
        }
    })
}
function bindDelete() {
    $("a#delete").click(function () {
        if (null != table) {
            var a = table.row(".selected").data();
            $("#modal_delete span#chn_abbr").text(a.chnAbbr);
            $("#modal_delete span#eng_abbr").text(a.engAbbr);
            $("#modal_delete").modal("show")
        }
    });
    $("#delete_ok").click(function () {
        var a = table.row(".selected").data().id;
        $.ajax({type: "post", url: "../../../api/admin/country/" + a + "/?method=delete"}).done(function (a) {
            0 === a.code ? (table.row(".selected").remove().draw(!1), sysAlert("success", "\u6210\u529f\uff01", "\u5220\u9664\u6210\u529f\u3002"),
                $("#modal_delete").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u5220\u9664\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u5220\u9664\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function initDataTable() {
    return $("#table-country").DataTable({
        pagingType: "simple_numbers",
        lengthMenu: [[12, 20, 50, -1], [12, 20, 50, "\u5168\u90e8"]],
        language: {url: "../../../static/datatables/locale/zh_CN.txt"},
        ajax: {url: "../../../api/admin/country/", type: "GET"},
        columns: [{data: "id"}, {data: "chnName"}, {data: "chnAbbr"}, {data: "engName"}, {data: "engAbbr"}, {data: "alpha2Code"}, {data: "alpha3Code"}, {data: "numCode"}],
        columnDefs: [{type: "chinese", targets: [1, 2]}, {searchable: !1, visible: !1, targets: 0}],
        order: [[0, "asc"]],
        initComplete: function () {
            var a = this.api();
            a.$("tr").click(function () {
                a.$("tr.selected").removeClass("selected");
                $(this).addClass("selected")
            })
        }
    })
}
function reloadTable() {
    table.destroy();
    table = initDataTable()
};
