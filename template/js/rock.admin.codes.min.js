var codes_table = null, gtable = null;
$(function () {
    gtable = initGroupTable();
    bindGroupNew();
    bindGroupEdit();
    bindGroupDelete();
    bindCodeNew();
    bindCodeEdit();
    bindCodeDelete()
});
function bindGroupNew() {
    $("a#new_group").click(function () {
        $("#modal_new_group input").val("");
        $("#modal_new_group textarea").val("");
        $("#modal_new_group").modal("show")
    });
    $("#group_new_ok").click(function () {
        checkRequired("#modal_new_group") && $.ajax({
            type: "POST",
            url: "../../api/admin/codegroups/",
            dataType: "json",
            data: {
                groupCode: $("#modal_new_group input[name=group_code]").val(),
                groupName: $("#modal_new_group input[name=group_name]").val(),
                description: $("#modal_new_group textarea[name=group_desc]").val()
            }
        }).done(function (b) {
            0 ===
            b.code ? (reloadGroupTab(), null != codes_table && (codes_table.destroy(), codes_table = null, $("#div_ctable").addClass("hidden")), sysAlert("success", "\u6210\u529f\uff01", "\u4fdd\u5b58\u4ee3\u7801\u7ec4\u6210\u529f\u3002"), $("#modal_new_group").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u4ee3\u7801\u7ec4\u5931\u8d25\u3002[" + b.msg + " " + b.code + "]")
        }).fail(function (b) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u4ee3\u7801\u7ec4\u5931\u8d25\u3002[" + b.status + " " + b.statusText + "]")
        })
    })
}
function bindGroupEdit() {
    $("a#edit_group").click(function () {
        if (null != gtable) {
            var b = gtable.row(".selected").data();
            $("#modal_edit_group input[name=group_code]").val(b.groupCode);
            $("#modal_edit_group input[name=group_name]").val(b.groupName);
            $("#modal_edit_group textarea[name=group_desc]").val(b.description);
            $("#modal_edit_group").modal("show")
        }
    });
    $("#group_edit_ok").click(function () {
        if (checkRequired("#modal_edit_group")) {
            var b = gtable.row(".selected").data().groupCode;
            $.ajax({
                type: "post",
                url: "../../api/admin/codegroups/" +
                b + "/?method=put",
                dataType: "json",
                data: {
                    groupName: $("#modal_edit_group input[name=group_name]").val(),
                    description: $("#modal_edit_group textarea[name=group_desc]").val()
                }
            }).done(function (a) {
                0 === a.code ? (a = gtable.row(".selected").data(), a.groupName = $("#modal_edit_group input[name=group_name]").val(), a.description = $("#modal_edit_group textarea[name=group_desc]").val(), gtable.row(".selected").data(a).draw(!1), sysAlert("success", "\u6210\u529f\uff01", "\u4fdd\u5b58\u6210\u529f\u3002"), $("#modal_edit_group").modal("hide")) :
                    sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
            }).fail(function (a) {
                sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
            })
        }
    })
}
function bindGroupDelete() {
    $("a#delete_group").click(function () {
        if (null != gtable) {
            var b = gtable.row(".selected").data();
            $("#modal_delete_group span#gcode").text(b.groupCode);
            $("#modal_delete_group span#gname").text(b.groupName);
            $("#modal_delete_group").modal("show")
        }
    });
    $("#group_delete_ok").click(function () {
        var b = gtable.row(".selected").data().groupCode;
        $.ajax({type: "post", url: "../../api/admin/codegroups/" + b + "/?method=delete"}).done(function (a) {
            0 === a.code ? (sysAlert("success", "\u6210\u529f\uff01", "\u5220\u9664\u6210\u529f\u3002"),
                gtable.row(".selected").remove().draw(!1), null != codes_table && (codes_table.destroy(), codes_table = null, $("#div_ctable").addClass("hidden")), $("#modal_delete_group").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u5220\u9664\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u5220\u9664\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function bindCodeNew() {
    $("a#new_code").click(function () {
        var b = gtable.row(".selected").data().groupCode;
        $("#modal_new_code input").val("");
        $("#modal_new_code textarea").val("");
        $("#modal_new_code input[name=group_code]").val(b);
        $("#modal_new_code").modal("show")
    });
    $("#code_new_ok").click(function () {
        if (checkRequired("#modal_new_code")) {
            var b = $("#modal_new_code input[name=group_code]").val();
            $.ajax({
                type: "POST", url: "../../api/admin/codegroups/" + b + "/codes/", dataType: "json", data: {
                    codeValue: $("#modal_new_code input[name=code_value]").val(),
                    codeName: $("#modal_new_code input[name=code_name]").val(), description: $("#modal_new_code textarea[name=code_desc]").val()
                }
            }).done(function (a) {
                0 === a.code ? (codes_table.row.add({
                    codeValue: $("#modal_new_code input[name=code_value]").val(),
                    codeName: $("#modal_new_code input[name=code_name]").val(),
                    description: $("#modal_new_code textarea[name=code_desc]").val(),
                    readonly: 0
                }).draw(!1).nodes().to$().click(function () {
                    codes_table.$("tr.selected").removeClass("selected");
                    $(this).addClass("selected")
                }), sysAlert("success",
                    "\u6210\u529f\uff01", "\u4ee3\u7801\u4fdd\u5b58\u6210\u529f\u3002"), $("#modal_new_code").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u4ee3\u7801\u4fdd\u5b58\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
            }).fail(function (a) {
                sysAlert("error", "\u9519\u8bef\uff01", "\u4ee3\u7801\u4fdd\u5b58\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
            })
        }
    })
}
function bindCodeEdit() {
    $("a#edit_code").click(function () {
        if (null != codes_table) {
            var b = gtable.row(".selected").data().groupCode, a = codes_table.row(".selected").data();
            $("#modal_edit_code input[name=group_code]").val(b);
            $("#modal_edit_code input[name=code_value]").val(a.codeValue);
            $("#modal_edit_code input[name=code_name]").val(a.codeName);
            $("#modal_edit_code textarea[name=code_desc]").val(a.description);
            $("#modal_edit_code").modal("show")
        }
    });
    $("#code_edit_ok").click(function () {
        if (checkRequired("#modal_edit_code")) {
            var b =
                $("#modal_edit_code input[name=group_code]").val(), a = codes_table.row(".selected").data();
            $.ajax({
                type: "post",
                url: "../../api/admin/codegroups/" + b + "/codes/" + a.codeValue + "/?method=put",
                dataType: "json",
                data: {codeName: $("#modal_edit_code input[name=code_name]").val(), description: $("#modal_edit_code textarea[name=code_desc]").val()}
            }).done(function (a) {
                0 === a.code ? (a = codes_table.row(".selected").data(), a.codeName = $("#modal_edit_code input[name=code_name]").val(), a.description = $("#modal_edit_code textarea[name=code_desc]").val(),
                    codes_table.row(".selected").data(a).draw(!1), sysAlert("success", "\u6210\u529f\uff01", "\u4ee3\u7801\u4fee\u6539\u6210\u529f\u3002"), $("#modal_edit_code").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u4ee3\u7801\u4fee\u6539\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
            }).fail(function (a) {
                sysAlert("error", "\u9519\u8bef\uff01", "\u4ee3\u7801\u4fee\u6539\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
            })
        }
    })
}
function bindCodeDelete() {
    $("a#delete_code").click(function () {
        if (null != codes_table) {
            var b = gtable.row(".selected").data(), a = codes_table.row(".selected").data();
            $("#modal_delete_code span#gcode").text(b.groupCode);
            $("#modal_delete_code span#gname").text(b.groupName);
            $("#modal_delete_code span#code").text(a.codeValue);
            $("#modal_delete_code span#cname").text(a.codeName);
            $("#modal_delete_code").modal("show")
        }
    });
    $("#code_delete_ok").click(function () {
        var b = gtable.row(".selected").data(), a = codes_table.row(".selected").data().codeValue;
        $.ajax({type: "post", url: "../../api/admin/codegroups/" + b.groupCode + "/codes/" + a + "/?method=delete"}).done(function (a) {
            0 === a.code ? (codes_table.row(".selected").remove().draw(!1), sysAlert("success", "\u6210\u529f\uff01", "\u4ee3\u7801\u5220\u9664\u6210\u529f\u3002"), $("#modal_delete_code").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u4ee3\u7801\u5220\u9664\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u4ee3\u7801\u5220\u9664\u5931\u8d25\u3002[" +
                a.status + " " + a.statusText + "]")
        })
    })
}
function reloadGroupTab() {
    gtable.destroy();
    gtable = initGroupTable()
}
function initGroupTable() {
    return $("#table-groups").DataTable({
        pagingType: "simple_numbers",
        lengthMenu: [[12, 20, 50, -1], [12, 20, 50, "\u5168\u90e8"]],
        language: {url: "../../static/datatables/locale/zh_CN.txt"},
        ajax: {url: "../../api/admin/codegroups/", type: "GET"},
        columns: [{data: "groupCode"}, {data: "groupName"}, {data: "description"}, {data: "readonly"}],
        columnDefs: [{type: "chinese", targets: [1, 2]}, {searchable: !1, visible: !1, targets: 3}],
        order: [[0, "asc"]],
        initComplete: function () {
            for (var b = this.api(), a = 0; a < b.rows().nodes().length; a++) {
                b.row(a).nodes().to$().data("groupCode",
                    b.row(a).data().groupCode);
                b.row(a).nodes().to$().data("readonly", b.row(a).data().readonly);
                var c = b.row(a).nodes().to$();
                1 === b.row(a).data().readonly ? c.css("background-color", "#f0f0f0") : 2 === b.row(a).data().readonly && c.css("background-color", "#ffffb4")
            }
            b.$("tr").click(function () {
                b.$("tr.selected").removeClass("selected");
                $(this).addClass("selected");
                0 === $(this).data().readonly ? ($("a#edit_group").removeClass("disabled"), $("a#delete_group").removeClass("disabled"), $("a#new_code").removeClass("disabled")) :
                    1 === $(this).data().readonly ? ($("a#edit_group").addClass("disabled"), $("a#delete_group").addClass("disabled"), $("a#new_code").addClass("disabled")) : 2 === $(this).data().readonly && ($("a#edit_group").addClass("disabled"), $("a#delete_group").addClass("disabled"), $("a#new_code").removeClass("disabled"));
                initCodeTable($(this).data().groupCode)
            })
        }
    })
}
function initCodeTable(b) {
    null != codes_table ? codes_table.destroy() : $("#div_ctable").removeClass("hidden");
    codes_table = $("#table-codes").DataTable({
        paging: !1,
        info: !1,
        language: {url: "../../static/datatables/locale/zh_CN.txt"},
        ajax: {url: "../../api/admin/codegroups/" + b + "/codes/", type: "GET"},
        columns: [{data: "codeValue"}, {data: "codeName"}, {data: "description"}, {data: "readonly"}],
        columnDefs: [{type: "chinese", targets: [1, 2]}, {searchable: !1, visible: !1, targets: 3}],
        order: [[0, "asc"]],
        initComplete: function () {
            for (var a =
                this.api(), b = 0; b < a.rows().nodes().length; b++) {
                a.row(b).nodes().to$().data("codeValue", a.row(b).data().codeValue);
                a.row(b).nodes().to$().data("readonly", a.row(b).data().readonly);
                var d = a.row(b).nodes().to$();
                1 === a.row(b).data().readonly && d.css("background-color", "#f0f0f0")
            }
            a.$("tr").click(function () {
                a.$("tr.selected").removeClass("selected");
                $(this).addClass("selected");
                0 === $(this).data().readonly ? ($("a#edit_code").removeClass("disabled"), $("a#delete_code").removeClass("disabled")) : ($("a#edit_code").addClass("disabled"),
                    $("a#delete_code").addClass("disabled"))
            })
        }
    })
};
