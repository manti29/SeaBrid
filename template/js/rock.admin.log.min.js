var log_tab = null;
$(function () {
    initDatePicker();
    log_tab = initTable();
    bindQuery();
    bindReset();
    bindView(log_tab)
});
function initDatePicker() {
    $("#date-from").datetimepicker().on("changeDate", function (a) {
        $("#date-to").datetimepicker("setStartDate", a.date);
        $("#date-to").datetimepicker("update", a.date);
        $("#date-to").datetimepicker("show")
    });
    $("#date-to").datetimepicker().on("changeDate", function (a) {
        $("#date-from").datetimepicker("setEndDate", a.date)
    });
    var b = $.format.date(new Date, "yyyy-MM-dd"), c = $.format.date(new Date - 6048E5, "yyyy-MM-dd");
    $("#date-to").val(b);
    $("#date-from").val(c)
}
function bindQuery() {
    $("#btn-query").click(function () {
        reloadTable()
    })
}
function bindReset() {
    $("#btn-reset").click(function () {
        initDatePicker()
    })
}
function reloadTable() {
    log_tab.destroy();
    log_tab = initTable()
}
function bindView(b) {
    $("a#view").click(function () {
        var b = log_tab.row(".selected").data();
        null != b && $.ajax({type: "get", url: "../../api/admin/log/" + b.id + "/"}).done(function (a) {
            0 === a.code ? ($("#modal_view p#log_type").text(null == a.data.logType ? "" : a.data.logType), $("#modal_view p#username").text(null == a.data.username ? "" : a.data.username), $("#modal_view p#real_name").text(null == a.data.clerkName ? "" : a.data.clerkName), $("#modal_view p#branch_no").text(null == a.data.branchNo ? "" : a.data.branchNo), $("#modal_view p#clerk_no").text(null ==
            a.data.clerkNo ? "" : a.data.clerkNo), $("#modal_view p#ip_address").text(null == a.data.ipAddress ? "" : a.data.ipAddress), $("#modal_view p#client_id").text(null == a.data.clientId ? "" : a.data.clientId), $("#modal_view p#res_code").text(null == a.data.resCode ? "" : a.data.resCode), $("#modal_view p#res_name").text(null == a.data.resName ? "" : a.data.resName), $("#modal_view p#method").text(null == a.data.method ? "" : a.data.method), $("#modal_view p#log_time").text(null == a.data.operationTime ? "" : a.data.operationTime), $("#modal_view p#res_url").text(null ==
            a.data.resUrl ? "" : a.data.resUrl), $("#modal_view p#agent").text(null == a.data.browserAgent ? "" : a.data.browserAgent), $("#modal_view textarea#req_msg").val(null == a.data.reqMsg ? "" : a.data.reqMsg), $("#modal_view").modal("show")) : sysAlert("error", "\u9519\u8bef\uff01", "\u67e5\u8be2\u65e5\u5fd7\u8be6\u60c5\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u67e5\u8be2\u65e5\u5fd7\u8be6\u60c5\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function initTable() {
    var b = $("#table-log").DataTable({
        pagingType: "simple_numbers",
        language: {url: "../../static/datatables/locale/zh_CN.txt"},
        serverSide: !0,
        processing: !0,
        dom: '<"row"<"col-sm-12"l>><"row"<"col-sm-12"t>><"row"<"col-sm-6"i><"col-sm-6"p>>',
        ajax: {url: "../../api/admin/log/", data: getFormJson($("#query-form"))},
        columns: [{data: "id"}, {data: "logType"}, {data: "username"}, {data: "operationTime"}, {data: "ipAddress"}, {data: "resName"}, {data: "method"}],
        columnDefs: [{type: "chinese", targets: [1, 2, 5]}, {
            searchable: !1,
            orderable: !1, targets: [0, 1, 2, 3, 4, 5, 6]
        }],
        order: [[3, "desc"]]
    });
    b.on("draw", function () {
        b.column(0, {search: "applied", order: "applied"}).nodes().each(function (b, a) {
            b.innerHTML = a + 1
        });
        b.$("tr").click(function () {
            b.$("tr.selected").removeClass("selected");
            $(this).addClass("selected")
        })
    });
    return b
};
