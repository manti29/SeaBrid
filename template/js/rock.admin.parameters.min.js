var table = null;
$(function () {
    table = initDataTable();
    bindNew();
    bindEdit();
    bindDelete()
});
function bindNew() {
    $("a#new").click(function () {
        $("#modal_new").modal("show")
    });
    $("#new_ok").click(function () {
        checkRequired("#modal_new") && $.ajax({
            type: "POST",
            url: "../../api/admin/params/",
            dataType: "json",
            data: {
                name: $("#modal_new input[name=name]").val(),
                value: $("#modal_new input[name=value]").val(),
                code: $("#modal_new input[name=code]").val(),
                description: $("#modal_new textarea[name=desc]").val()
            }
        }).done(function (a) {
            0 === a.code ? (reloadTable(), sysAlert("success", "\u6210\u529f\uff01", "\u4fdd\u5b58\u53c2\u6570\u6210\u529f\u3002"),
                $("#modal_new").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u53c2\u6570\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u53c2\u6570\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function bindEdit() {
    $("a#edit").click(function () {
        if (null != table) {
            var a = table.row(".selected").data();
            $("#modal_edit input[name=code]").val(a.paraCode);
            $("#modal_edit input[name=name]").val(a.paraName);
            $("#modal_edit input[name=value]").val(a.paraValue);
            $("#modal_edit textarea[name=desc]").val(a.description);
            $("#modal_edit").modal("show")
        }
    });
    $("#edit_ok").click(function () {
        if (checkRequired("#modal_edit")) {
            var a = table.row(".selected").data().paraCode;
            $.ajax({
                type: "post",
                url: "../../api/admin/params/" +
                a + "/?method=put",
                dataType: "json",
                data: {
                    name: $("#modal_edit input[name=name]").val(),
                    value: $("#modal_edit input[name=value]").val(),
                    description: $("#modal_edit textarea[name=desc]").val()
                }
            }).done(function (a) {
                0 === a.code ? (a = table.row(".selected").data(), a.paraName = $("#modal_edit input[name=name]").val(), a.paraValue = $("#modal_edit input[name=value]").val(), a.description = $("#modal_edit textarea[name=desc]").val(), table.row(".selected").data(a).draw(!1), sysAlert("success", "\u6210\u529f\uff01", "\u4fee\u6539\u53c2\u6570\u6210\u529f\u3002"),
                    $("#modal_edit").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u4fee\u6539\u53c2\u6570\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
            }).fail(function (a) {
                sysAlert("error", "\u9519\u8bef\uff01", "\u4fee\u6539\u53c2\u6570\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
            })
        }
    })
}
function bindDelete() {
    $("a#delete").click(function () {
        if (null != table) {
            var a = table.row(".selected").data();
            $("#modal_delete span#code").text(a.paraCode);
            $("#modal_delete span#name").text(a.paraName);
            $("#modal_delete").modal("show")
        }
    });
    $("#delete_ok").click(function () {
        var a = table.row(".selected").data().paraCode;
        $.ajax({type: "post", url: "../../api/admin/params/" + a + "/?method=delete"}).done(function (a) {
            0 === a.code ? (table.row(".selected").remove().draw(!1), sysAlert("success", "\u6210\u529f\uff01", "\u5220\u9664\u53c2\u6570\u6210\u529f\u3002"),
                $("#modal_delete").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u5220\u9664\u53c2\u6570\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u5220\u9664\u53c2\u6570\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function reloadTable() {
    table.destroy();
    table = initDataTable()
}
function initDataTable() {
    return $("#table-parameters").DataTable({
        pagingType: "simple_numbers",
        lengthMenu: [[12, 20, 50, -1], [12, 20, 50, "\u5168\u90e8"]],
        language: {url: "../../static/datatables/locale/zh_CN.txt"},
        ajax: {url: "../../api/admin/params/", type: "GET"},
        columns: [{data: "paraCode"}, {data: "paraName"}, {data: "paraValue"}, {data: "description"}],
        columnDefs: [{type: "chinese", targets: [1, 3]}],
        order: [[0, "asc"]],
        initComplete: function () {
            var a = this.api();
            a.$("tr").click(function () {
                a.$("tr.selected").removeClass("selected");
                $(this).addClass("selected")
            })
        }
    })
};
