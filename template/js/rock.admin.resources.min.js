$(function () {
    initResources()
});
function initResources() {
    $.ajax({type: "get", url: "../../api/admin/resources/", data: {part: "all"}}).done(function (a) {
        0 === a.code ? (showDetails(a.data), $("#details").removeClass("hidden"), $("#dataTableAffix").width($("#divc").width())) : sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u7cfb\u7edf\u8d44\u6e90\u4fe1\u606f\u5931\u8d25\uff01 [" + a.msg + " " + a.code + "]")
    }).fail(function (a) {
        sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u7cfb\u7edf\u8d44\u6e90\u4fe1\u606f\u5931\u8d25\uff01 [" + a.status + " " +
            a.statusText + "]")
    })
}
function showDetails(a) {
    var c = [];
    $("#dataTableAffix").html("").height($("html").height() - 110);
    $("#resAffix>ul").html("");
    $("#resList").html("");
    for (var b = 0; b < a.length; b++) {
        $("#resAffix>ul").append('<li><a name="' + a[b].group_id + '">' + a[b].group_name + "</a></li>");
        $("#res_list_block h4").attr("id", "resgroup-" + a[b].group_id).text(a[b].group_name);
        $("#res_list_block table").attr("id", "tb-resgroup-" + a[b].group_id);
        $("#resList").append($("#res_list_block").html());
        var d = $("#resList #tb-resgroup-" + a[b].group_id).DataTable({
            paging: !1,
            info: !1,
            language: {url: "../../static/datatables/locale/zh_CN.txt"},
            data: a[b].resources,
            columns: [{data: "res_id"}, {data: "sort"}, {data: "res_name"}, {data: "res_type"}, {data: "security_level"}, {data: "res_desc"}],
            columnDefs: [{type: "chinese", targets: [2, 4, 5]}, {searchable: !1, visible: !1, targets: [0, 1]}],
            order: [[1, "asc"]]
        });
        c.push(d)
    }
    initAffix();
    for (b = 0; b < c.length; b++)for (a = 0; a < c[b].rows().nodes().length; a++) {
        var d = c[b].row(a).nodes().to$(), f = c[b].row(a).data().res_id, e = c[b].row(a).data().res_type, g = c[b].row(a).data().options;
        "Web Page" === e ? d.append('<td width="300">' + $("#actions_block_html").html() + "</td>") : "REST Service" === e ? d.append('<td width="300">' + $("#actions_block_rest").html() + "</td>") : d.append('<td width="300"> </td>');
        d.data("resid", f);
        d.data("has_meta", c[b].row(a).data().has_meta);
        0 < d.find("input").length && d.find("input").each(function () {
            0 <= g.toLowerCase().indexOf($(this).attr("name")) && $(this).attr("checked", !0)
        });
        d.on("click", function () {
            var a = !1;
            debugger;
            for (var b = 0; b < c.length; b++)for (var d = 0; d < c[b].rows().nodes().length; d++)if (c[b].row(d).data().res_id ===
                $(this).data("resid")) {
                var e = c[b].row(d).nodes().to$();
                e.toggleClass("selected");
                c[b].row(d).data();
                e.hasClass("selected") && (a = !0)
            }
            $(this).data("has_meta") && (b = $(this).data("resid"), a ? initDataTableAuth(b) : $("#dataTableAffix>div#wrapper-" + b).remove())
        })
    }
}
function initAffix() {
    $(".console-tab-affix").affix({offset: {top: 110}});
    $("#resAffix li").click(function () {
        $(this).parent().find("li.active").removeClass("active");
        $(this).addClass("active");
        window.scrollTo(0, $("#resgroup-" + $(this).find("a").attr("name")).offset().top - 115)
    })
}
function initDataTableAuth(a) {
    if (!(0 < $("#dataTableAffix #dtable-" + a).length)) {
        debugger;
        $.ajax({type: "get", url: "../../api/admin/resources/" + a + "/meta/"}).done(function (c) {
            0 === c.code ? (c = c.data, $("#datatable_block h5>span").text(c.name), $("#datatable_block>div[name=wrapper]").attr("id", "wrapper-" + a), $("#datatable_block table").attr("id", "dtable-" + a), $("#dataTableAffix").append($("#datatable_block").html()), $("#dataTableAffix #dtable-" + a).DataTable({
                paging: !1,
                info: !1,
                filter: !1,
                language: {url: "../../static/datatables/locale/zh_CN.txt"},
                data: c.cols,
                columns: [{data: "attr_id"}, {data: "sort_no"}, {data: "attr_name"}, {data: "attr_type"}],
                columnDefs: [{type: "chinese", targets: [2, 3]}, {searchable: !1, visible: !1, targets: [0, 1]}],
                order: [[1, "asc"]],
                initComplete: function () {
                    var b = this.api();
                    b.$("tr").click(function () {
                        $(this).hasClass("selected") ? $(this).removeClass("selected") : (b.$("tr.selected").removeClass("selected"), $(this).addClass("selected"))
                    });
                    for (var c = 0; c < b.rows().nodes().length; c++)b.row(c).nodes().to$().data("colid", b.row(c).data().attr_id);
                    $("#dataTableAffix #dtable-" + a).width($("#divc").width() - 20)
                }
            })) : sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u8d44\u6e90\u5143\u6570\u636e\u5931\u8d25\uff01 [" + c.msg + " " + c.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u8d44\u6e90\u5143\u6570\u636e\u5931\u8d25\uff01 [" + a.status + " " + a.statusText + "]")
        })
    }
};
