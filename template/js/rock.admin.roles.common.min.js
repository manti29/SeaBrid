function genRoleDef() {
    var b = [];
    $("table[id|=tb-resgroup]").each(function () {
        $(this).find("tr.selected").each(function () {
            var a = {};
            a.res_id = $(this).data("resid");
            a.actions = "";
            $(this).find("input:checked").each(function () {
                a.actions += $(this).attr("name").toUpperCase() + ","
            });
            "" != a.actions && (a.actions = a.actions.substring(0, a.actions.length - 1));
            $(this).data("has_meta") && (a.cols = "", $("table[id=dtable-" + a.res_id + "]").find("tbody>tr:not(.selected)").each(function () {
                a.cols += $(this).data("colid") + ","
            }), "" != a.cols &&
            (a.cols = a.cols.substring(0, a.cols.length - 1)));
            for (var c = !1, f = 0; f < b.length; f++)if (b[f].res_id === a.res_id) {
                c = !0;
                break
            }
            c || b.push(a)
        })
    });
    return b
}
function showDetails(b, a, c, f, d, g) {
    $("#tabblock li").attr("id", "tab-" + a);
    1 < $("#tabs>ul>li").length && $("#tabs>ul>li:last").remove();
    null != b && ($("#tabblock li>a>span[name=title]").text(c), $("#roledef span[name=role_name]").text(c));
    $("#tabs>ul").append($("#tabblock").html());
    $("#tabs>ul>li:last").data("roleid", a);
    initTabClick(f);
    var e = [];
    $("#dataTableAffix").html("").height($("html").height() - 110);
    $("#resAffix>ul").html("");
    $("#resList").html("");
    for (b = 0; b < d.length; b++)$("#resAffix>ul").append('<li><a name="' +
        d[b].group_id + '">' + d[b].group_name + "</a></li>"), $("#res_list_block h4").attr("id", "resgroup-" + d[b].group_id).text(d[b].group_name), $("#res_list_block table").attr("id", "tb-resgroup-" + d[b].group_id), $("#resList").append($("#res_list_block").html()), a = $("#resList #tb-resgroup-" + d[b].group_id).DataTable({
        paging: !1,
        info: !1,
        language: {url: "../../static/datatables/locale/zh_CN.txt"},
        data: d[b].resources,
        columns: [{data: "res_id"}, {data: "sort"}, {data: "res_name"}, {data: "res_type"}, {data: "res_desc"}],
        columnDefs: [{
            type: "chinese",
            targets: [2, 4]
        }, {searchable: !1, visible: !1, targets: [0, 1]}],
        order: [[1, "asc"]]
    }), e.push(a);
    initAffix();
    for (b = 0; b < e.length; b++)for (d = 0; d < e[b].rows().nodes().length; d++) {
        a = e[b].row(d).nodes().to$();
        c = e[b].row(d).data().res_id;
        f = e[b].row(d).data().res_type;
        var k = e[b].row(d).data().options;
        "Web Page" === f ? a.append('<td width="300">' + $("#actions_block_html").html() + "</td>") : "REST Service" === f ? a.append('<td width="300">' + $("#actions_block_rest").html() + "</td>") : a.append('<td width="300"> </td>');
        a.data("resid",
            c);
        a.data("has_meta", e[b].row(d).data().has_meta);
        if (0 < a.find("input").length)a.find("input").each(function () {
            0 > k.toLowerCase().indexOf($(this).attr("name")) && $(this).parent().remove()
        }), a.find("input").on("change", function () {
            for (var b = 0; b < e.length; b++)for (var a = 0; a < e[b].rows().nodes().length; a++)if (e[b].row(a).data().res_id === $(this).parents("tr").data("resid")) {
                for (var a = e[b].row(a).nodes().to$(), c = a.find("input"), d = 0; d < c.length; d++)if (c[d].name === $(this).attr("name")) {
                    c[d].checked = $(this).context.checked;
                    break
                }
                1 > a.find("input:checked").length ? a.removeClass("selected") : a.addClass("selected");
                break
            }
            if ($(this).parents("tr").data("has_meta"))if (b = $(this).parents("tr").data("resid"), 0 < $(this).parents("tr").find("input[name=head]:checked").length || 0 < $(this).parents("tr").find("input[name=get]:checked").length) {
                c = ALLCOLS;
                for (a = 0; a < g.length; a++)if (b === g[a].res_id) {
                    c = g[a].cols;
                    break
                }
                initDataTableAuth(b, c)
            } else $("#dataTableAffix>div#wrapper-" + b).remove()
        }); else a.on("click", function () {
            for (var a = 0; a < e.length; a++)for (var b =
                0; b < e[a].rows().nodes().length; b++)if (e[a].row(b).data().res_id === $(this).data("resid")) {
                var c = e[a].row(b).nodes().to$();
                c.toggleClass("selected");
                e[a].row(b).data();
                c.hasClass("selected")
            }
        });
        for (var h = 0; h < g.length; h++)c === g[h].res_id && (a.addClass("selected"), a.find("input").each(function () {
            0 <= g[h].actions.toLowerCase().indexOf($(this).attr("name")) && $(this).attr("checked", !0)
        }), null != g[h].cols && initDataTableAuth(c, g[h].cols))
    }
}
function initDefTab(b, a) {
    $.ajax({type: "get", url: "../../api/admin/resources/"}).done(function (c) {
        0 === c.code ? null != b ? $.ajax({type: "get", url: "../../api/admin/roles/" + b + "/privillege/"}).done(function (f) {
            0 === f.code ? (showDetails(b, b, a, "rolemgt", c.data, f.data), $("#tabs li#tab-" + b).click()) : sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u89d2\u8272\u6743\u9650\u5b9a\u4e49\u5931\u8d25\uff01 [" + c.msg + " " + c.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u89d2\u8272\u6743\u9650\u5b9a\u4e49\u5931\u8d25\uff01 [" +
                c.status + " " + c.statusText + "]")
        }) : (showDetails(b, "roledef", a, "rolebasic", c.data, []), $("#tabs li#tab-roledef").removeClass("hidden"), $("#tabs li#tab-roledef").click()) : sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u7cfb\u7edf\u8d44\u6e90\u4fe1\u606f\u5931\u8d25\uff01 [" + c.msg + " " + c.code + "]")
    }).fail(function (a) {
        sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u7cfb\u7edf\u8d44\u6e90\u4fe1\u606f\u5931\u8d25\uff01 [" + a.status + " " + a.statusText + "]")
    })
}
function initAffix() {
    $("#roledef .console-tab-affix").affix({offset: {top: 110}});
    $("#roledef #resAffix li").click(function () {
        $(this).parent().find("li.active").removeClass("active");
        $(this).addClass("active");
        window.scrollTo(0, $("#roledef #resgroup-" + $(this).find("a").attr("name")).offset().top - 115)
    })
}
var ALLCOLS = "ALL-COLS";
function initDataTableAuth(b, a) {
    0 < $("#dataTableAffix #dtable-" + b).length || $.ajax({type: "get", url: "../../api/admin/resources/" + b + "/meta/"}).done(function (c) {
        0 === c.code ? (c = c.data, $("#datatable_block h5>span").text(c.name), $("#datatable_block>div[name=wrapper]").attr("id", "wrapper-" + b), $("#datatable_block table").attr("id", "dtable-" + b), $("#dataTableAffix").append($("#datatable_block").html()), $("#dataTableAffix #dtable-" + b).DataTable({
            paging: !1,
            info: !1,
            filter: !1,
            language: {url: "../../static/datatables/locale/zh_CN.txt"},
            data: c.cols,
            columns: [{data: "attr_id"}, {data: "sort_no"}, {data: "attr_name"}, {data: "attr_type"}],
            columnDefs: [{type: "chinese", targets: [2, 3]}, {searchable: !1, visible: !1, targets: [0, 1]}],
            order: [[1, "asc"]],
            initComplete: function () {
                var c = this.api();
                c.$("tr").click(function () {
                    $(this).toggleClass("selected")
                });
                for (var d = 0; d < c.rows().nodes().length; d++)c.row(d).nodes().to$().data("colid", c.row(d).data().attr_id), (a === ALLCOLS || 0 > a.indexOf(c.row(d).data().attr_id)) && c.row(d).nodes().to$().addClass("selected");
                $("#dataTableAffix #dtable-" +
                    b).width($("#divc").width() - 20)
            }
        })) : sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u8d44\u6e90\u5143\u6570\u636e\u5931\u8d25\uff01 [" + c.msg + " " + c.code + "]")
    }).fail(function (a) {
        sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u8d44\u6e90\u5143\u6570\u636e\u5931\u8d25\uff01 [" + a.status + " " + a.statusText + "]")
    })
}
function initTabClick(b) {
    $(".nav-tabs>li").click(function () {
        $(this).parent().find("li.active").removeClass("active");
        $(this).addClass("active");
        $(this).attr("id") === "tab-" + b ? ($("#" + b).removeClass("hidden"), $("#roledef").addClass("hidden")) : ($("#" + b).addClass("hidden"), $("#roledef").removeClass("hidden"), $("#dataTableAffix").width($("#divc").width()))
    });
    $(".nav-tabs>li .close").click(function () {
        $li = $(this).parent().parent();
        $ul = $li.parent();
        $li.remove();
        $li.hasClass("active") && $ul.find("li:first").click()
    })
}
;
