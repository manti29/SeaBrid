var t = null;
$(function () {
    initTree1();
    initTree2();
    t = initRolesTable();
    bindClone();
    bindEdit();
    bindToggleEnable();
    bindDefine();
    bindAudit()
});
var __branchNo = "";
function initTree1() {
    $("#branchtree1").treeview({
        data: getBranchTree("../../api/admin/branch_tree/"),
        nodeIcon: "glyphicon",
        emptyIcon: "glyphicon",
        expandIcon: "glyphicon glyphicon-plus",
        collapseIcon: "glyphicon glyphicon-minus",
        showTags: !0,
        levels: 3,
        onNodeSelected: function (b, a) {
            $("#q_branch_code").val(a.no);
            $("#q_branch_name").val(a.text);
            __branchNo = a.no
        }
    });
    $("#branchtree1>ul>li:first").click()
}
function initTree2() {
    $("#branchtree2").treeview({
        data: getBranchTree("../../api/admin/branch_tree/"),
        nodeIcon: "glyphicon",
        emptyIcon: "glyphicon",
        expandIcon: "glyphicon glyphicon-plus",
        collapseIcon: "glyphicon glyphicon-minus",
        showTags: !0,
        levels: 2
    });
    $("#branchtree2").on("nodeSelected", function (b, a) {
        $("#to_branchcode").val(a.no);
        $("#to_branchname").val(a.text)
    });
    $("#branchtree2").on("click", function () {
        1 > $(this).find("li.node-selected").length && ($("#to_branchcode").val(""), $("#to_branchname").val(""))
    })
}
function initRolesTable() {
    var b = $("#table-roles").DataTable({
        pagingType: "simple_numbers",
        language: {url: "../../static/datatables/locale/zh_CN.txt"},
        ajax: {
            url: "../../api/admin/roles/",
            type: "GET",
            data: {
                roleName: $("#q_rolename").val(),
                branchNo: $("#q_branch_code").val(),
                bizLine: $("#q_bizline").val(),
                stat: $("#q_role_stat").val(),
                q_sub: $("input[name=q_sub]:checked").val()
            }
        },
        columns: [{data: "roleId"}, {data: "roleName"}, {data: "branchName"}, {data: "description"}, {data: "startDate"}, {data: "endDate"}, {data: "status"}],
        columnDefs: [{type: "chinese", targets: [1, 2, 3, 6]}, {searchable: !1, orderable: !1, targets: 0}],
        order: [[2, "asc"], [1, "asc"]],
        initComplete: function () {
            this.api().$("tr").click(function () {
                $(this).toggleClass("selected");
                1 < t.rows(".selected").data().length ? ($("a#clone").addClass("disabled"), $("a#edit").addClass("disabled"), $("a#audit").addClass("disabled"), $("a#def").addClass("disabled")) : ($("a#clone").removeClass("disabled"), $("a#edit").removeClass("disabled"), $("a#audit").removeClass("disabled"), "\u6709\u6548" ===
                t.row(".selected").data().status ? $("a#def").removeClass("disabled") : $("a#def").addClass("disabled"))
            })
        }
    });
    b.on("order.dt search.dt", function () {
        b.column(0, {search: "applied", order: "applied"}).nodes().each(function (a, b) {
            a.innerHTML = b + 1
        })
    }).draw();
    return b
}
$("#query").click(function () {
    reloadTable()
});
$("#reset").click(function () {
    $("#q_rolename").val("");
    $("#q_bizline").val("");
    $("#q_role_stat").val("A")
});
function reloadTable() {
    t.destroy();
    t = initRolesTable()
}
function bindClone() {
    $("a#clone").click(function () {
        var b = t.row(".selected").data();
        null != b && ($("#modal_clone #clone_msg").text("\u5c06\u89d2\u8272 " + b.roleName + " \u590d\u5236\u5230\u54ea\u4e2a\u673a\u6784\uff1f"), $("#modal_clone #new_role_name").val(b.roleName), $("#modal_clone").modal("show"))
    });
    $("#clone_ok").click(function () {
        var b = $("#to_branchcode").val();
        "" === b ? sysAlert("warning", "", "\u8bf7\u9009\u62e9\u8981\u5c06\u89d2\u8272\u590d\u5236\u5230\u54ea\u4e2a\u673a\u6784\u3002") : checkRequired("#modal_clone") &&
        $.ajax({
            type: "post",
            url: "../../api/admin/roles/",
            data: {from_roleid: t.row(".selected").data().roleId, to_branch: b, new_name: $("#modal_clone #new_role_name").val()}
        }).done(function (a) {
            0 == a.code ? (sysAlert("success", "\u6210\u529f\uff01", "\u590d\u5236\u89d2\u8272\u6210\u529f\u3002"), reloadTable(), $("#modal_clone").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u590d\u5236\u89d2\u8272\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u590d\u5236\u89d2\u8272\u5931\u8d25\u3002[" +
                a.status + " " + a.statusText + "]")
        })
    })
}
function bindEdit() {
    $("a#edit").click(function () {
        var b = t.row(".selected").data();
        null != b && $.ajax({type: "get", url: "../../api/admin/roles/" + b.roleId + "/"}).done(function (a) {
            0 === a.code ? ($("#modal_edit input#branch_code").val(a.data.branchNo), $("#modal_edit input#branch_name").val(a.data.branchName), $("#modal_edit select#biz_line").val(a.data.bizLineCode), $("#modal_edit input#role_name").val(a.data.roleName), $("#modal_edit p#role_status").text(a.data.status), $("#modal_edit p#start_date").text(a.data.startDate), $("#modal_edit p#end_date").text(a.data.endDate),
                $("#modal_edit p#create_time").text(a.data.createTime), $("#modal_edit p#update_time").text(a.data.lastUpdTime), $("#modal_edit textarea#desc").text(a.data.description), $("#modal_edit").modal("show")) : sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u89d2\u8272\u4fe1\u606f\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u89d2\u8272\u4fe1\u606f\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    });
    $("#edit_ok").click(function () {
        if (checkRequired("#modal_edit")) {
            var b =
                t.row(".selected").data().roleId;
            $.ajax({
                type: "post",
                url: "../../api/admin/roles/" + b + "/?method=put",
                dataType: "json",
                data: {
                    roleName: $("#modal_edit input#role_name").val(),
                    bizLineCode: $("#modal_edit select#biz_line").val(),
                    description: $("#modal_edit textarea#desc").val()
                }
            }).done(function (a) {
                0 === a.code ? (a = t.row(".selected").data(), a.roleName = $("#modal_edit input#role_name").val(), a.description = $("#modal_edit textarea#desc").val(), t.row(".selected").data(a).draw(!1), sysAlert("success", "\u6210\u529f\uff01",
                    "\u89d2\u8272\u4fdd\u5b58\u6210\u529f\u3002"), $("#modal_edit").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u89d2\u8272\u4fdd\u5b58\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
            }).fail(function (a) {
                sysAlert("error", "\u9519\u8bef\uff01", "\u89d2\u8272\u4fdd\u5b58\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
            })
        }
    })
}
function bindToggleEnable() {
    var b = "A", a, c, g, h;
    $("a#toggle_enable").click(function () {
        var e = t.rows(".selected").data();
        if (null != e)if (chkSelectedUsersStatus(e)) {
            var f = getSelectedRoles(e);
            "\u505c\u7528" === e[0].status ? ($("#modal_enable .modal-title").text("\u542f\u7528\u89d2\u8272"), $("#modal_enable .modal-body").text("\u786e\u5b9a\u8981\u542f\u7528 " + f + " \u5417\uff1f"), b = "A", a = "\u6709\u6548", c = $.format.date(new Date, "yyyy-MM-dd"), g = "", h = "\u542f\u7528") : ($("#modal_enable .modal-title").text("\u505c\u7528\u89d2\u8272"),
                $("#modal_enable .modal-body").text("\u786e\u5b9a\u8981\u505c\u7528 " + f + " \u5417\uff1f"), b = "B", a = "\u505c\u7528", g = $.format.date(new Date, "yyyy-MM-dd"), h = "\u505c\u7528");
            $("#modal_enable").modal("show")
        } else sysAlert("error", "\u9519\u8bef:", "\u6240\u9009\u89d2\u8272\u7684\u72b6\u6001\u4e0d\u4e00\u81f4")
    });
    $("#enable_ok").click(function () {
        for (var e = t.rows(".selected").data(), f = "", k = 0; k < e.length; k++)f += e[k].roleId, k != e.length - 1 && (f += ",");
        $.ajax({
            type: "post", url: "../../api/admin/roles/" + f + "/?method=put",
            dataType: "json", data: {stat: b}
        }).done(function (d) {
            if (0 === d.code) {
                for (d = 0; d < t.rows(".selected").nodes().length; d++)"A" === b && t.cell(t.rows(".selected").indexes()[d], "4:visIdx").data(c), t.cell(t.rows(".selected").indexes()[d], "5:visIdx").data(g), t.cell(t.rows(".selected").indexes()[d], "6:visIdx").data(a);
                sysAlert("success", "\u6210\u529f\uff01", h + "\u89d2\u8272\u6210\u529f\u3002");
                $("#modal_enable").modal("hide")
            } else sysAlert("error", "\u9519\u8bef\uff01", h + "\u89d2\u8272\u5931\u8d25\u3002[" + d.msg + " " + d.code +
                "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", h + "\u89d2\u8272\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function bindDefine() {
    $("a#def").click(function () {
        var b = t.row(".selected").data();
        if (null != b) {
            var a = b.roleId;
            1 > $("#tabs li#tab-" + a).length ? initDefTab(a, b.roleName) : $("#tabs li#tab-" + b.roleId).click()
        }
    })
}
function bindAudit() {
    $("a#audit").click(function () {
        var b = t.row(".selected").data();
        null != b && (window.location.href = encodeURI("../../admin/auth_query_by_role/?roleId=" + b.roleId + "&branchNo=" + __branchNo))
    })
}
$("#def_ok").click(function () {
    var b = t.row(".selected").data().roleId, a = genRoleDef();
    $.ajax({
        type: "POST",
        url: "../../api/admin/roles/" + b + "/privillege/?method=put",
        dataType: "json",
        data: {roledef: JSON.stringify(a)}
    }).done(function (a) {
        "0" == a.code ? sysAlert("success", "\u6210\u529f\uff01", "\u4fdd\u5b58\u89d2\u8272\u6743\u9650\u5b9a\u4e49\u6210\u529f\u3002") : sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u89d2\u8272\u6743\u9650\u5b9a\u4e49\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
    }).fail(function (a) {
        sysAlert("error",
            "\u9519\u8bef\uff01", "\u4fdd\u5b58\u89d2\u8272\u6743\u9650\u5b9a\u4e49\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
    })
});
function chkSelectedUsersStatus(b) {
    for (var a = b[0].status, c = !0, g = 0; g < b.length; g++)if (b[g].status != a) {
        c = !1;
        break
    }
    return c
}
function getSelectedRoles(b) {
    for (var a = "", c = 0; c < b.length; c++)a += b[c].roleName, c < b.length - 1 && (a += ", ");
    return a
};
