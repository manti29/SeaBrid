var user_table = null;
$(function () {
    initTree();
    user_table = initTable();
    bindQuery();
    bindReset();
    bindEdit();
    bindToggleEnable();
    bindToggleFreeze();
    bindAuth();
    bindSetPwd()
});
function initTree() {
    $("#tree").treeview({
        data: getBranchTree("../../api/admin/branch_tree/"),
        nodeIcon: "glyphicon",
        emptyIcon: "glyphicon",
        expandIcon: "glyphicon glyphicon-plus",
        collapseIcon: "glyphicon glyphicon-minus",
        showTags: !0,
        levels: 3,
        onNodeSelected: function (a, b) {
            $("#q_branch_code").val(b.no);
            $("#q_branch_name").val(b.text)
        }
    });
    $("#tree>ul>li:first").click()
}
function bindQuery() {
    $("#btn-query").click(function () {
        $("a#edit").removeClass("disabled");
        $("a#authorize").removeClass("disabled");
        reloadTable()
    })
}
function bindReset() {
    $("#btn-reset").click(function () {
        var a = $("#q_branch_code").val(), b = $("#q_branch_name").val();
        $("#working_area form input[type!='button']").val("");
        $("#q_branch_code").val(a);
        $("#q_branch_name").val(b)
    })
}
function bindEdit() {
    $("a#edit").click(function () {
        var a = user_table.row(".selected").data();
        null != a && $.ajax({type: "get", url: "../../api/admin/users/" + a.username + "/"}).done(function (a) {
            0 === a.code ? ($("#modal_edit input#branch_code").val(a.data.branchNo), $("#modal_edit input#branch_name").val(a.data.branchName), $("#modal_edit input#username").val(a.data.username), $("#modal_edit input#clerk_no").val(a.data.clerkNo), $("#modal_edit input#realname").val(a.data.realName), $("#modal_edit select#gender").val(a.data.genderCode),
                $("#modal_edit input#email").val(a.data.email), $("#modal_edit input#mobile").val(a.data.mobile), $("#modal_edit p#stat").text(a.data.status), $("#modal_edit p#lockedTime").text(a.data.lockedTime), $("#modal_edit p#startDate").text(a.data.startDate), $("#modal_edit p#endDate").text(a.data.endDate), $("#modal_edit p#createTime").text(a.data.createTime), $("#modal_edit p#lastUpdTime").text(a.data.lastUpdTime), $("#modal_edit").modal("show")) : sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u5931\u8d25\u3002[" +
                a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    });
    $("#edit_ok").click(function () {
        checkRequired("#modal_edit") && $.ajax({
            type: "post",
            url: "../../api/admin/users/" + $("#modal_edit input#username").val() + "/",
            data: getFormJson($("#modal_edit form"))
        }).done(function (a) {
            0 === a.code ? (a = user_table.row(".selected").data(), a.username = $("#modal_edit input#username").val(), a.realName = $("#modal_edit input#realname").val(),
                a.gender = $("#modal_edit select#gender :selected").text(), user_table.row(".selected").data(a).draw(!1), sysAlert("success", "\u6210\u529f\uff01", "\u4fdd\u5b58\u7528\u6237\u6210\u529f\u3002"), $("#modal_edit").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u7528\u6237\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u4fdd\u5b58\u7528\u6237\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function bindToggleEnable() {
    $("a#toggle_enable").click(function () {
        var a = user_table.rows(".selected").data();
        if (null != a)if (chkSelectedUsersStatus(a)) {
            var b = getSelectedUsers(a);
            "\u505c\u7528" == a[0].status ? ($("#modal_enable .modal-title").text("\u542f\u7528\u7528\u6237"), $("#modal_enable .modal-body").text("\u786e\u5b9a\u8981\u542f\u7528 " + b + " \u5417\uff1f")) : ($("#modal_enable .modal-title").text("\u505c\u7528\u7528\u6237"), $("#modal_enable .modal-body").text("\u786e\u5b9a\u8981\u505c\u7528 " + b + " \u5417\uff1f"));
            $("#modal_enable").modal("show")
        } else sysAlert("error", "\u9519\u8bef:", "\u6240\u9009\u7528\u6237\u7684\u72b6\u6001\u4e0d\u4e00\u81f4")
    });
    $("#enable_ok").click(function () {
        var a = user_table.rows(".selected").data(), b, c, d, e;
        "\u505c\u7528" == a[0].status ? (b = "\u542f\u7528", c = "A", d = "\u6709\u6548", e = "") : (b = "\u505c\u7528", c = "B", d = "\u505c\u7528", e = $.format.date(new Date, "yyyy-MM-dd"));
        a = getSelectedUsernames(a);
        $.ajax({type: "post", url: "../../api/admin/users/" + a + "/?method=put", data: {stat: c}}).done(function (a) {
            if (0 ===
                a.code) {
                for (a = 0; a < user_table.rows(".selected").nodes().length; a++)user_table.cell(user_table.rows(".selected").indexes()[a], "6:visIdx").data(e), user_table.cell(user_table.rows(".selected").indexes()[a], "7:visIdx").data(d);
                sysAlert("success", b + "\u6210\u529f\uff01", b + "\u7528\u6237\u6210\u529f\u3002");
                $("#modal_enable").modal("hide")
            } else sysAlert("error", "\u9519\u8bef\uff01", b + "\u7528\u6237\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", b + "\u7528\u6237\u5931\u8d25\u3002[" +
                a.status + " " + a.statusText + "]")
        })
    })
}
function bindToggleFreeze() {
    $("a#toggle_freeze").click(function () {
        var a = user_table.rows(".selected").data();
        if (null != a)if ($("#freeze_ok").removeClass("hidden"), $("#freeze_cancel").text("\u53d6\u6d88"), chkSelectedUsersStatus(a)) {
            var b = getSelectedUsers(a);
            "\u51bb\u7ed3" == a[0].status ? ($("#modal_freeze .modal-title").text("\u89e3\u51bb\u7528\u6237"), $("#modal_freeze .modal-body").text("\u786e\u5b9a\u8981\u89e3\u51bb " + b + " \u5417\uff1f")) : "\u6709\u6548" == a[0].status ? ($("#modal_freeze .modal-title").text("\u51bb\u7ed3\u7528\u6237"),
                $("#modal_freeze .modal-body").text("\u786e\u5b9a\u8981\u51bb\u7ed3 " + b + " \u5417\uff1f")) : ($("#modal_freeze .modal-title").text("\u51bb\u7ed3\u7528\u6237"), $("#modal_freeze .modal-body").text("\u7528\u6237 " + b + " \u5df2\u505c\u7528\uff0c\u65e0\u6cd5\u51bb\u7ed3\u3002"), $("#freeze_ok").addClass("hidden"), $("#freeze_cancel").text("\u5173\u95ed"));
            $("#modal_freeze").modal("show")
        } else sysAlert("error", "\u9519\u8bef:", "\u6240\u9009\u7528\u6237\u7684\u72b6\u6001\u4e0d\u4e00\u81f4")
    });
    $("#freeze_ok").click(function () {
        var a =
            user_table.rows(".selected").data(), b, c, d;
        "\u51bb\u7ed3" == a[0].status ? (b = "\u89e3\u51bb", c = "A", d = "\u6709\u6548") : (b = "\u51bb\u7ed3", c = "C", d = "\u51bb\u7ed3");
        a = getSelectedUsernames(a);
        $.ajax({type: "post", url: "../../api/admin/users/" + a + "/?method=put", data: {stat: c}}).done(function (a) {
            if (0 === a.code) {
                for (a = 0; a < user_table.rows(".selected").nodes().length; a++)user_table.cell(user_table.rows(".selected").indexes()[a], "7:visIdx").data(d);
                sysAlert("success", b + "\u6210\u529f\uff01", b + "\u7528\u6237\u6210\u529f\u3002");
                $("#modal_freeze").modal("hide")
            } else sysAlert("error", "\u9519\u8bef\uff01", b + "\u7528\u6237\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", b + "\u7528\u6237\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function bindSetPwd() {
    $("a#set_pwd").click(function () {
        $("#modal_pwd input").val("");
        var a = user_table.row(".selected").data();
        null != a && ($("#modal_pwd span[name=username]").text(a.username), $("#modal_pwd").modal("show"))
    });
    $("#pwd_ok").click(function () {
        checkRequired("#modal_pwd") && $.ajax({
            type: "post",
            url: "../../api/admin/users/" + $("#modal_pwd span[name=username]").text() + "/password/?method=put",
            data: {password: $("#modal_pwd input#new_pwd").val()}
        }).done(function (a) {
            0 === a.code ? (sysAlert("success", "\u6210\u529f\uff01",
                "\u5bc6\u7801\u8bbe\u7f6e\u6210\u529f\u3002"), $("#modal_pwd").modal("hide")) : sysAlert("error", "\u9519\u8bef\uff01", "\u5bc6\u7801\u8bbe\u7f6e\u5931\u8d25\u3002[" + a.msg + " " + a.code + "]")
        }).fail(function (a) {
            sysAlert("error", "\u9519\u8bef\uff01", "\u5bc6\u7801\u8bbe\u7f6e\u5931\u8d25\u3002[" + a.status + " " + a.statusText + "]")
        })
    })
}
function chkSelectedUsersStatus(a) {
    for (var b = a[0].status, c = !0, d = 0; d < a.length; d++)if (a[d].status != b) {
        c = !1;
        break
    }
    return c
}
function getSelectedUsers(a) {
    for (var b = "", c = 0; c < a.length; c++)b += a[c].username, c < a.length - 1 && (b += ", ");
    return b
}
function initTable() {
    var a = $("#table-users").DataTable({
        pagingType: "simple_numbers",
        language: {url: "../../static/datatables/locale/zh_CN.txt"},
        ajax: {url: "../../api/admin/users/", data: getFormJson($("#working_area form"))},
        columns: [{data: null}, {data: "username"}, {data: "branchName"}, {data: "realName"}, {data: "gender"}, {data: "startDate"}, {data: "endDate"}, {data: "status"}],
        columnDefs: [{type: "chinese", targets: [1, 2, 3, 4, 7]}, {searchable: !1, orderable: !1, targets: 0}],
        order: [[2, "asc"], [1, "asc"]],
        initComplete: function () {
            this.api().$("tr").click(function () {
                $(this).toggleClass("selected");
                1 < a.rows(".selected").data().length ? ($("a#edit").addClass("disabled"), $("a#set_pwd").addClass("disabled"), $("a#authorize").addClass("disabled")) : ($("a#edit").removeClass("disabled"), $("a#set_pwd").removeClass("disabled"), $("a#authorize").removeClass("disabled"))
            })
        }
    });
    a.on("order.dt search.dt", function () {
        a.column(0, {search: "applied", order: "applied"}).nodes().each(function (a, c) {
            a.innerHTML = c + 1
        })
    }).draw();
    return a
}
function bindAuth() {
    $("#authorize").click(function () {
        var a = user_table.row(".selected").data();
        null != a && (window.location.href = encodeURI("../../admin/auth/?username=" + a.username))
    })
}
function reloadTable() {
    user_table.destroy();
    user_table = initTable()
}
function getSelectedUsernames(a) {
    for (var b = "", c = 0; c < a.length; c++)b += a[c].username, c < a.length - 1 && (b += ",");
    return b
};
